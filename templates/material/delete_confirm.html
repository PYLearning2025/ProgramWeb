{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-6 mx-auto">
      <!-- 頁面標題 -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>
          <i class="bi bi-exclamation-triangle text-danger me-3"></i>
          確認刪除
        </h2>
        <a href="{% url 'ManageMaterials' %}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-1"></i>
          返回管理區
        </a>
      </div>

      <!-- 刪除確認卡片 -->
      <div class="card border-danger">
        <div class="card-header bg-danger text-white">
          <h5 class="mb-0">
            <i class="bi bi-trash me-2"></i>
            刪除確認
          </h5>
        </div>
        <div class="card-body">
          {% if material %}
          <!-- 教材刪除 -->
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>注意：</strong>您即將刪除以下教材：
          </div>

          <div class="mb-3">
            <h6><strong>教材標題：</strong></h6>
            <p class="text-primary">{{ material.title }}</p>
          </div>

          <div class="mb-3">
            <h6><strong>所屬單元：</strong></h6>
            <p>{{ material.unit.title }}</p>
          </div>

          {% if material.content %}
          <div class="mb-3">
            <h6><strong>教材內容：</strong></h6>
            <p class="text-muted">{{ material.content|truncatewords:20 }}</p>
          </div>
          {% endif %}

          <div class="mb-3">
            <h6><strong>建立時間：</strong></h6>
            <p>{{ material.created_at|date:"Y-m-d H:i" }}</p>
          </div>

          {% elif unit %}
          <!-- 單元刪除 -->
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>注意：</strong>您即將刪除以下單元：
          </div>

          <div class="mb-3">
            <h6><strong>單元標題：</strong></h6>
            <p class="text-primary">{{ unit.title }}</p>
          </div>

          {% if unit.description %}
          <div class="mb-3">
            <h6><strong>單元描述：</strong></h6>
            <p class="text-muted">{{ unit.description }}</p>
          </div>
          {% endif %}

          <div class="mb-3">
            <h6><strong>教材數量：</strong></h6>
            <p>{{ unit.materials.count }} 個教材</p>
          </div>

          {% if unit.materials.exists %}
          <div class="alert alert-danger">
            <i class="bi bi-x-circle me-2"></i>
            <strong>無法刪除：</strong>此單元下還有 {{ unit.materials.count }} 個教材，請先刪除所有教材後再刪除單元。
          </div>
          {% endif %}

          {% elif category %}
          <!-- 類型刪除 -->
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>注意：</strong>您即將刪除以下教材類型：
          </div>

          <div class="mb-3">
            <h6><strong>類型名稱：</strong></h6>
            <p class="text-primary">{{ category.name }}</p>
          </div>

          {% if category.description %}
          <div class="mb-3">
            <h6><strong>類型描述：</strong></h6>
            <p class="text-muted">{{ category.description }}</p>
          </div>
          {% endif %}
          {% endif %}

          <hr>

          <!-- 操作按鈕 -->
          {% if not unit or not unit.materials.exists %}
          <form method="post" class="d-inline" id="deleteForm">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger me-3">
              <i class="bi bi-trash me-1"></i>
              確認刪除
            </button>
          </form>
          {% endif %}

          <a href="{% url 'ManageMaterials' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle me-1"></i>
            取消
          </a>
        </div>
      </div>

      <!-- 警告說明 -->
      <div class="card mt-4">
        <div class="card-body">
          <h6 class="card-title text-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            重要提醒
          </h6>
          <ul class="text-muted mb-0">
            <li>刪除操作<strong>無法復原</strong>，請謹慎操作</li>
            {% if material %}
            <li>刪除教材將同時移除相關的PDF檔案</li>
            {% elif unit %}
            <li>單元下有教材時無法刪除，需先清空所有教材</li>
            {% elif category %}
            <li>刪除類型不會影響現有教材的分類</li>
            {% endif %}
            <li>建議在刪除前先備份重要資料</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const deleteForm = document.getElementById('deleteForm');
  if (deleteForm) {
    deleteForm.addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      fetch(this.action || window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(data.message);
            if (data.redirect) {
              window.location.href = "{% url 'ManageMaterials' %}";
            }
          } else {
            alert(data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('發生錯誤，請稍後再試。');
        });
    });
  }
</script>
{% endblock %}